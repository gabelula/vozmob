<?php

// $Id: mm_views.module,v 1.1.2.1 2008/06/27 23:51:48 arthuregg Exp $;

/* *************************************************************** */
/* VIEWS functions */
/* *************************************************************** */

/**
 * define media mover api tables to join
 *
 * @return array of tables 
 */
function mm_views_views_tables() {
  
  $table = views_new_table('media_mover_files', 'internal', 'node', 'nid', 'nid');
  views_table_add_filter($table, 'cid', 'Media Mover: Configuration files', t('This will filter a view to nodes that have files with files generated by this Media Mover configuration.'), 
    array(
      'list' => 'views_handler_filter_media_mover_api_list',
      'operator' => array('AND' => t('Has files from all'), 'OR' => t('Has files from any'), 'NOR' => t('Has files from none')),
      'handler' => 'views_handler_filter_media_mover_api_custom',
      'value-type' => 'array',    
      'list-type' => 'multiselect',
     )
   );

  $tables[$table['name']] = $table;
  return $tables;
}


/**
 * Builds the config list for views
 * @return array of configurations 
 */
function views_handler_filter_media_mover_api_list() {
  // get a list of all configurations
  $results = db_query('SELECT cid, name FROM {media_mover_config_list} ORDER BY cid');
  while ($config = db_fetch_object($results)) {
    $mmconfig[$config->cid] = $config->name;
  }
  return $mmconfig;
}


/**
 * build the joins for the media mover config filter
 *
 * @param string $op
 * @param array $value
 * @param unknown_type $depth
 * @param unknown_type $query
 */
function views_handler_filter_media_mover_api_custom($op, $filter, $filterinfo, &$query) {
  
  $tablename = $query->get_table_name('media_mover_files', $num);
  $query->add_table($tablename, false, 1, array('left' => array('table' => 'node', 'field' => 'nid'), 'right' => array('field' => 'nid'))); 

  // build the where clause
  switch ($filter['operator']) {
    case 'OR':      
      $clause = "'" . implode("','", $filter['value']) . "'";
      $where = "$tablename.cid IN ($clause)";
      $query->add_where($where);      
    break;
 
    case 'AND':
      foreach ($filter['value'] as $cid) {
        $clause[] = "$tablename.cid = $cid";
      }
      $query->add_where(implode(' AND ', $clause));
    break;
    
    case 'NOR':
      $clause = "'" . implode("','", $filter['value']) . "'";
      $where = "$tablename.cid NOT IN ($clause)";
      $query->add_where($where);
    break;

    default:
      $query->add_where('');
    break;
  }
  
}
